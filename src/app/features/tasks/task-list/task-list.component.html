<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">My Tasks</h1>
      <p class="text-gray-600 dark:text-gray-400">Manage your daily tasks efficiently</p>
    </div>

    <!-- Add Task Button -->
    <div class="mb-6">
      <button 
        (click)="openAddModal()"
        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors shadow-lg flex items-center space-x-2">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        <span>Add New Task</span>
      </button>
    </div>

    <!-- Modal for Create/Edit Task -->
    <app-modal [isOpen]="isModalOpen" [title]="editingTask ? 'Edit Task' : 'Create New Task'" (close)="closeModal()">
        <app-task-form 
           [task]="editingTask" 
           (cancel)="closeModal()">
        </app-task-form>
    </app-modal>

    <!-- Search Bar -->
    <div class="mb-6 relative">
      <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          (ngModelChange)="onSearch($event)" 
          placeholder="Search tasks by title, description, or tags..." 
          class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all shadow-sm"
      >
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
      </div>
    </div>

    <!-- Kanban Board -->
    <div class="flex flex-col md:flex-row gap-6 pb-6" cdkDropListGroup>
      
      <!-- To Do Column -->
      <div class="flex-1 min-w-[300px]">
        <div class="bg-gray-100 dark:bg-gray-800 rounded-lg p-4 h-full">
          <h2 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4 flex items-center justify-between">
            <span>To Do</span>
            <span class="bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 py-1 px-2 rounded-full text-xs">
              {{ todoTasks.length }}
            </span>
          </h2>
          
          <div
            cdkDropList
            id="todo"
            [cdkDropListData]="todoTasks"
            (cdkDropListDropped)="drop($event)"
            class="space-y-4 min-h-[100px]">
            
            <div *ngFor="let task of todoTasks" cdkDrag [cdkDragStartDelay]="dragDelay">
              <app-task-item [task]="task" (edit)="openEditModal($any($event))" (view)="openViewModal($event)"></app-task-item>
            </div>

             <!-- Empty State for Column -->
             <div *ngIf="todoTasks.length === 0" class="text-center py-8 text-gray-400 dark:text-gray-500 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg">
                No tasks
             </div>
          </div>
        </div>
      </div>

      <!-- In Progress Column -->
      <div class="flex-1 min-w-[300px]">
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 h-full">
          <h2 class="text-lg font-semibold text-blue-700 dark:text-blue-300 mb-4 flex items-center justify-between">
            <span>In Progress</span>
            <span class="bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-300 py-1 px-2 rounded-full text-xs">
              {{ inProgressTasks.length }}
            </span>
          </h2>
          
          <div
            cdkDropList
            id="in-progress"
            [cdkDropListData]="inProgressTasks"
            (cdkDropListDropped)="drop($event)"
            class="space-y-4 min-h-[100px]">
            
            <div *ngFor="let task of inProgressTasks" cdkDrag [cdkDragStartDelay]="dragDelay">
              <app-task-item [task]="task" (edit)="openEditModal($any($event))" (view)="openViewModal($event)"></app-task-item>
            </div>

            <div *ngIf="inProgressTasks.length === 0" class="text-center py-8 text-gray-400 dark:text-gray-500 border-2 border-dashed border-blue-200 dark:border-blue-800 rounded-lg">
                Drag tasks here
             </div>
          </div>
        </div>
      </div>

      <!-- Done Column -->
      <div class="flex-1 min-w-[300px]">
        <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 h-full">
          <h2 class="text-lg font-semibold text-green-700 dark:text-green-300 mb-4 flex items-center justify-between">
            <span>Done</span>
            <span class="bg-green-100 dark:bg-green-800 text-green-600 dark:text-green-300 py-1 px-2 rounded-full text-xs">
              {{ doneTasks.length }}
            </span>
          </h2>
          
          <div
            cdkDropList
            id="done"
            [cdkDropListData]="doneTasks"
            (cdkDropListDropped)="drop($event)"
            class="space-y-4 min-h-[100px]">
            
            <div *ngFor="let task of doneTasks" cdkDrag [cdkDragStartDelay]="dragDelay">
              <app-task-item [task]="task" (edit)="openEditModal($any($event))" (view)="openViewModal($event)"></app-task-item>
            </div>

            <div *ngIf="doneTasks.length === 0" class="text-center py-8 text-gray-400 dark:text-gray-500 border-2 border-dashed border-green-200 dark:border-green-800 rounded-lg">
                Drag completed tasks here
             </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Original Loading State -->
    <div *ngIf="!(tasks$ | async) && (todoTasks.length === 0 && inProgressTasks.length === 0 && doneTasks.length === 0)" class="flex justify-center py-12">
        <app-loader></app-loader>
    </div>

    <!-- View Task Modal -->
    <app-modal [isOpen]="isViewModalOpen" [title]="viewingTask?.title || 'Task Details'" (close)="closeViewModal()">
       <div *ngIf="viewingTask" class="p-1">
          <!-- Header with Checkbox and Status -->
          <div class="flex items-center justify-between mb-4">
             <div class="flex items-center space-x-3">
                <input 
                  type="checkbox" 
                  [checked]="viewingTask.completed" 
                  (change)="toggleViewTaskComplete(viewingTask)"
                  class="h-6 w-6 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                
                <span [ngClass]="{
                   'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300': !viewingTask.status || viewingTask.status === 'todo',
                   'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300': viewingTask.status === 'in-progress',
                   'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300': viewingTask.status === 'done'
                }" class="px-2.5 py-0.5 rounded-full text-sm font-medium">
                   {{ (viewingTask.status || 'To Do') | titlecase }}
                </span>
             </div>
          </div>

          <!-- Description -->
          <div *ngIf="viewingTask.description" class="prose dark:prose-invert max-w-none mb-6">
             <div class="flex items-center justify-between mb-2">
                <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider">Description</h4>
             </div>
             <div [class.opacity-50]="viewingTask.completed" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700 transition-opacity">
                <markdown [data]="viewingTask.description"></markdown>
             </div>
          </div>

          <!-- Subtasks -->
          <div *ngIf="viewingTask.subtasks && viewingTask.subtasks.length > 0" class="mb-6">
             <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-2">Subtasks</h4>
             <div class="space-y-2">
                <div *ngFor="let sumbtask of viewingTask.subtasks; let i = index" class="flex items-start space-x-3 p-2 rounded hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                   <input 
                     type="checkbox" 
                     [checked]="sumbtask.completed" 
                     (change)="toggleViewSubtaskComplete(viewingTask, i)"
                     class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded cursor-pointer">
                   <span [class.line-through]="sumbtask.completed" class="text-gray-700 dark:text-gray-300">{{ sumbtask.title }}</span>
                </div>
             </div>
          </div>

          <!-- Meta Info -->
          <div class="grid grid-cols-2 gap-4 text-sm text-gray-500 dark:text-gray-400 border-t border-gray-200 dark:border-gray-700 pt-4">
             <div>
                <span class="block text-xs font-bold uppercase text-gray-400">Due Date</span>
                <span>{{ viewingTask.dueDate ? (viewingTask.dueDate.toDate() | date:'mediumDate') : 'No date' }}</span>
             </div>
             <div>
                <span class="block text-xs font-bold uppercase text-gray-400">Priority</span>
                <span [ngClass]="{
                    'text-red-500': viewingTask.priority === 'high',
                    'text-yellow-500': viewingTask.priority === 'medium',
                    'text-green-500': viewingTask.priority === 'low'
                }" class="font-medium capitalize">{{ viewingTask.priority || 'None' }}</span>
             </div>
          </div>
          
          <div class="mt-6 flex justify-end">
             <button (click)="closeViewModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-medium">Close</button>
          </div>
       </div>
    </app-modal>

  </div>
</div>